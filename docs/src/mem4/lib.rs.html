<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source to the Rust file `mem4/src/lib.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>lib.rs.html -- source</title><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../dark.css"><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script src="../../storage.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="shortcut icon" href="../../favicon.ico"><style type="text/css">#crate-search{background-image:url("../../down-arrow.svg");}</style></head><body class="rustdoc source"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../../mem4/index.html'><div class='logo-container'><img src='../../rust-logo.png' alt='logo'></div></a></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../../theme.js"></script><nav class="sub"><form class="search-form js-only"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><a id="settings-menu" href="../../settings.html"><img src="../../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><pre class="line-numbers"><span id="1">  1</span>
<span id="2">  2</span>
<span id="3">  3</span>
<span id="4">  4</span>
<span id="5">  5</span>
<span id="6">  6</span>
<span id="7">  7</span>
<span id="8">  8</span>
<span id="9">  9</span>
<span id="10"> 10</span>
<span id="11"> 11</span>
<span id="12"> 12</span>
<span id="13"> 13</span>
<span id="14"> 14</span>
<span id="15"> 15</span>
<span id="16"> 16</span>
<span id="17"> 17</span>
<span id="18"> 18</span>
<span id="19"> 19</span>
<span id="20"> 20</span>
<span id="21"> 21</span>
<span id="22"> 22</span>
<span id="23"> 23</span>
<span id="24"> 24</span>
<span id="25"> 25</span>
<span id="26"> 26</span>
<span id="27"> 27</span>
<span id="28"> 28</span>
<span id="29"> 29</span>
<span id="30"> 30</span>
<span id="31"> 31</span>
<span id="32"> 32</span>
<span id="33"> 33</span>
<span id="34"> 34</span>
<span id="35"> 35</span>
<span id="36"> 36</span>
<span id="37"> 37</span>
<span id="38"> 38</span>
<span id="39"> 39</span>
<span id="40"> 40</span>
<span id="41"> 41</span>
<span id="42"> 42</span>
<span id="43"> 43</span>
<span id="44"> 44</span>
<span id="45"> 45</span>
<span id="46"> 46</span>
<span id="47"> 47</span>
<span id="48"> 48</span>
<span id="49"> 49</span>
<span id="50"> 50</span>
<span id="51"> 51</span>
<span id="52"> 52</span>
<span id="53"> 53</span>
<span id="54"> 54</span>
<span id="55"> 55</span>
<span id="56"> 56</span>
<span id="57"> 57</span>
<span id="58"> 58</span>
<span id="59"> 59</span>
<span id="60"> 60</span>
<span id="61"> 61</span>
<span id="62"> 62</span>
<span id="63"> 63</span>
<span id="64"> 64</span>
<span id="65"> 65</span>
<span id="66"> 66</span>
<span id="67"> 67</span>
<span id="68"> 68</span>
<span id="69"> 69</span>
<span id="70"> 70</span>
<span id="71"> 71</span>
<span id="72"> 72</span>
<span id="73"> 73</span>
<span id="74"> 74</span>
<span id="75"> 75</span>
<span id="76"> 76</span>
<span id="77"> 77</span>
<span id="78"> 78</span>
<span id="79"> 79</span>
<span id="80"> 80</span>
<span id="81"> 81</span>
<span id="82"> 82</span>
<span id="83"> 83</span>
<span id="84"> 84</span>
<span id="85"> 85</span>
<span id="86"> 86</span>
<span id="87"> 87</span>
<span id="88"> 88</span>
<span id="89"> 89</span>
<span id="90"> 90</span>
<span id="91"> 91</span>
<span id="92"> 92</span>
<span id="93"> 93</span>
<span id="94"> 94</span>
<span id="95"> 95</span>
<span id="96"> 96</span>
<span id="97"> 97</span>
<span id="98"> 98</span>
<span id="99"> 99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
</pre><div class="example-wrap"><pre class="rust ">
<span class="comment">//region: lmake_readme insert &quot;readme.md&quot;</span>
<span class="doccomment">//! **mem4 is a simple memory game made primarily for learning the Rust programming language and Wasm/WebAssembly with Virtual Dom Dodrio and WebSocket communication**  </span>
<span class="doccomment">//! </span>
<span class="doccomment">//! version: 19.9.10  </span>
<span class="doccomment">//! Look also at the workspace readme on https://github.com/bestia-dev/mem4_game  </span>
<span class="doccomment">//! </span>
<span class="doccomment">//! # Idea</span>
<span class="doccomment">//! </span>
<span class="doccomment">//! Playing the memory game alone is boring.  </span>
<span class="doccomment">//! Playing it with friends is better.  </span>
<span class="doccomment">//! But if all friends just stare in their smartphones, it is still boring.  </span>
<span class="doccomment">//! What makes memory games (and other board games) entertaining is the company of friends.  </span>
<span class="doccomment">//! There must be many friends around the table watching one another and stealing moves and laughing and screaming at each other.  </span>
<span class="doccomment">//! Today I assume everybody has a decent smartphone. If all friends open the mem4 game and put their smartphones on the center of the table one near the other so that everybody can see them and touch them, this is the closest it gets to a classic board game.  </span>
<span class="doccomment">//! All the phones will have a small card grid (ex. 3x3). But the combined card grid from all these phones together is not so small anymore. It is now much more interesting to play for the players.  </span>
<span class="doccomment">//! It can be played with as many friends as there are: 3,4,5,...  </span>
<span class="doccomment">//! More friends - more fun.  </span>
<span class="doccomment">//! </span>
<span class="doccomment">//! ## Rust and Wasm/WebAssembly</span>
<span class="doccomment">//! </span>
<span class="doccomment">//! Rust is a pretty new language created by Mozilla for really low level programming.  </span>
<span class="doccomment">//! It is a step forward from the C language with functionality and features that are best practice today.  </span>
<span class="doccomment">//! It is pretty hard to learn. Some concepts are so different from other languages it makes it</span>
<span class="doccomment">//! hard for beginners. Lifetimes are the strangest and most confusing concept.  </span>
<span class="doccomment">//! The Rust language has been made from the ground up with an ecosystem that makes it productive.  </span>
<span class="doccomment">//! The language and most of the libraries are Open Source. That is good and bad, but mostly good.  </span>
<span class="doccomment">//! Rust is the best language today to compile into Wasm/WebAssembly.  </span>
<span class="doccomment">//! That compiled code works inside a browser directly with the JavaScript engine.  </span>
<span class="doccomment">//! So finally no need for JavaScript to make cross-platform applications inside browsers.  </span>
<span class="doccomment">//! I have a lot of hope here.  </span>
<span class="doccomment">//! ## Virtual DOM</span>
<span class="doccomment">//! Constructing a HTML page with Virtual DOM (vdom) is easier  </span>
<span class="doccomment">//! because it is rendered completely on every tick (animation frame).  </span>
<span class="doccomment">//! Sometimes is hard for the developer to think what should change in the UI when some data changes.  </span>
<span class="doccomment">//! The data can change from many different events and very chaotically (asynchronously).  </span>
<span class="doccomment">//! It is easier to think how to render the complete DOM for the given data.  </span>
<span class="doccomment">//! The Rust Dodrio library has ticks, time intervals when it do something.  </span>
<span class="doccomment">//! If a rendering is scheduled, it will be done on the next tick.  </span>
<span class="doccomment">//! If a rendering is not scheduled I believe nothing happens.  </span>
<span class="doccomment">//! This enables asynchronous changing of data and rendering. They cannot happen theoretically in the</span>
<span class="doccomment">//! same exact moment. So, no data race here.  </span>
<span class="doccomment">//! When GameData change and we know it will affect the DOM, then rendering must be scheduled.  </span>
<span class="doccomment">//! The main component of the Dodrio Virtual Dom is the root rendering component.  </span>
<span class="doccomment">//! It is the component that renders the complete user interface (HTML).  </span>
<span class="doccomment">//! The root rendering component is easily splitted  into sub-components.  </span>
<span class="doccomment">//! ![](https://github.com/bestia-dev/mem4_game/raw/master/docs/img/subcomponents.png)  </span>
<span class="doccomment">//! Some subcomponents don&#39;t need any extra data and can be coded as simple functions.  </span>
<span class="doccomment">//! The subcomponent &quot;players and scores&quot; has its own data. This data is cached from the GameData.  </span>
<span class="doccomment">//! When this data does not match, invalidation is called to cache them.</span>
<span class="doccomment">//! That also schedules the rendering of the subcomponent.  </span>
<span class="doccomment">//! If no data has changed, the cached subcomponent Node is used. This is more efficient and performant.  </span>
<span class="doccomment">//! ##GameData</span>
<span class="doccomment">//! All the game data are in this simple struct.  </span>
<span class="doccomment">//! ## WebSocket communication</span>
<span class="doccomment">//! HTML5 has finally bring a true stateful bidirectional communication.  </span>
<span class="doccomment">//! Most of the programming problems are more easily and effectively solved this way.  </span>
<span class="doccomment">//! The old unidirectional stateless communication is very good for static html pages,  </span>
<span class="doccomment">//! but is terrible for any dynamic page. The WebSocket is very rudimental and often the  </span>
<span class="doccomment">//! communication breaks for many different reasons. The programmer must deal with it inside the application.  </span>
<span class="doccomment">//! The protocol has nothing that can be used to deal with reconnections.  </span>
<span class="doccomment">//! I send simple structs text messages in json format between the players.  </span>
<span class="doccomment">//! They are all in the WsMsg enum and therefore interchangeable.  </span>
<span class="doccomment">//! The WebSocket server is coded especially for this game and recognizes 3 types of msg:</span>
<span class="doccomment">//! - msg to broadcast to every other player</span>
<span class="doccomment">//! - msg to send only to the actual game players</span>
<span class="doccomment">//! ## WS reconnect</span>
<span class="doccomment">//! TODO: It looks that plain web sockets have often connection problems and they disconnect here and there. Creating a good reconnect is pretty challenging.  </span>
<span class="doccomment">//! ## The game flow</span>
<span class="doccomment">//! In a few words: Status1 - User action - Status2, Status1 - WsMessage - Status2</span>
<span class="doccomment">//! In one moment the game is in a certain Game Status. The user then makes an action.</span>
<span class="doccomment">//! This action changes the GameData and the GameStatus.  </span>
<span class="doccomment">//! Then a message is sent to other players so they can also change their local GameData and GameStatus.  </span>
<span class="doccomment">//! The rendering is scheduled and it will happen shortly (async).   </span>
<span class="doccomment">//!  </span>
<span class="doccomment">//! | Game Status1       | Render                     | User action                                 | Condition                            | GameStatus2 t.p.   | Sends Msg          | On rcv Msg o.p.              | GameStatus2 o.p.                   |</span>
<span class="doccomment">//! | ------------------ | -------------------------- | ------------------------------------------- | ------------------------------------ | ----------------   | ----------------   | --------------------------   | --------------------------------   |</span>
<span class="doccomment">//! | InviteAskBegin     | div_invite_ask_begin       | div_invite_ask_begin_on_click               | -                                    | InviteAsking       | Invite             | on_msg_invite                | InviteAsked                        |</span>
<span class="doccomment">//! | InviteAsked        | div_invite_asked, div_play_accepted | div_invite_asked_on_click          | -                                    | PlayAccepted       | PlayAccept         | on_msg_play_accept           | -                                  |</span>
<span class="doccomment">//! | InviteAsking       | div_invite_asking          | game_data_init                              | -                                    | PlayBefore1stCard  | GameDataInit       | on_msg_game_data_init        | PlayBefore1stCard                  |</span>
<span class="doccomment">//! | PlayBefore1stCard  | div_grid_container         | div_grid_item_on_click, on_click_1st_card();| -                                    | PlayBefore2ndCard  | PlayerClick1stCard | on_msg_player_click_1st_card | PlayBefore2ndCard                  |</span>
<span class="doccomment">//! | PlayBefore2ndCard  | div_grid_container         | div_grid_item_on_click, on_click_2nd_card();| If card match and points&lt;all point   | PlayBefore1stCard  | PlayerClick2ndCard | on_msg_player_click_2nd_card | PlayBefore1stCard                  |</span>
<span class="doccomment">//! | -II-               | -II-                       | -II-                                        | If card match and points=&gt;all points | GameOverPlayAgainBegin | GameOverPlayAgainBegin  | on_msg_play_again   | GameOverPlayAgainBegin             |</span>
<span class="doccomment">//! | -II-               | -II-                       | -II-                                        | else                                 | TakeTurnBegin      | TakeTurnBegin      | on_msg_take_turn             | TakeTurnBegin                      |</span>
<span class="doccomment">//! | TakeTurnBegin      | div_take_turn_begin        | div_take_turn_begin_on_click                | -                                    | PlayBefore1stCard  | TakeTurnEnd        | on_msg_take_turn_end         | PlayBefore1stCard, the next player |</span>
<span class="doccomment">//! | GameOverPlayAgainBegin | div_play_again         | window.location().reload()                  | -                                    | -                  | -                  | -                            | -                                  |</span>
<span class="doccomment">//! |  |  |  |  |  |  |  |  |</span>
<span class="doccomment">//!  </span>
<span class="doccomment">//! t.p. = this player,   o.p. = other players,  rrc = root_rendering_component, rcv = receive</span>
<span class="doccomment">//! 1. Some actions can have different results. For example the condition card match or card don’t match.  </span>
<span class="doccomment">//! 2. one action must be only for one status1. This action changes Status for this player and sends Msg to other players.  </span>
<span class="doccomment">//! 3. on receive msg can produce only one status2.  </span>
<span class="doccomment">//! 4. in this table I ignore msgs for the server like GetConfig  </span>
<span class="doccomment">//!  </span>
<span class="doccomment">//! ## Futures and Promises, Rust and JavaScript</span>
<span class="doccomment">//! JavaScript is all asynchronous. Wasm is nothing else then a shortcut to the JavaScript engine.  </span>
<span class="doccomment">//! So everything is asynchronous too. This is pretty hard to grasp. Everything is Promises and Futures.  </span>
<span class="doccomment">//! There is a constant jumping from thinking in Rust to thinking is JavaScript and back. That is pretty confusing.  </span>
<span class="doccomment">//! JavaScript does not have a good idea of Rust datatypes. All there is is a generic JSValue type.  </span>
<span class="doccomment">//! The library `wasm-bindgen` has made a fantastic job of giving Rust the ability to call</span>
<span class="doccomment">//! anything JavaScript can call, but the way of doing it is sometimes very hard to understand.  </span>
<span class="doccomment">//! ## Typed html</span>
<span class="doccomment">//! Writing html inside Rust code is much easier with the macro `html!` from the `crate typed-html`  </span>
<span class="doccomment">//! https://github.com/bodil/typed-html  </span>
<span class="doccomment">//! It has also a macro `dodrio!` created exclusively for the dodrio vdom.  </span>
<span class="doccomment">//! Everything is done in compile time, so the runtime is nothing slower.</span>
<span class="doccomment">//! ## Browser console</span>
<span class="doccomment">//! At least in modern browsers (Firefox and Chrome) we have the developer tools F12 and there is a</span>
<span class="doccomment">//! console we can output to. So we can debug what is going on with our Wasm program.</span>
<span class="doccomment">//! But not on smartphones that are the only target for this app.  </span>
<span class="doccomment">//! ## Safari on iOS and FullScreen</span>
<span class="doccomment">//! Apple is very restrictive and does not allow fullscreen Safari on iPhones.  </span>
<span class="doccomment">//! The workaround is to make a shortcut for the webapp on the homescreen.  </span>
<span class="doccomment">//! ## mem4 as webapp on HomeScreen</span>
<span class="doccomment">//! On both android and iPhone is possible to &quot;Add to homescreen&quot; the webapp.  </span>
<span class="doccomment">//! Then it will open in fullscreen and be beautiful.  </span>
<span class="doccomment">//! In safari the share icon (a square with arrow up) has &quot;Add to home screen&quot;.</span>
<span class="doccomment">//! https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html  </span>
<span class="doccomment">//! ## Modules</span>
<span class="doccomment">//! Rust code is splitted into modules. They are not exactly like classes, but can be similar.  </span>
<span class="doccomment">//! Rust has much more freedom to group code in different ways. So that is best suits the problem.  </span>
<span class="doccomment">//! I splitted the rendering into sub-components.  </span>
<span class="doccomment">//! And then I splitted the User Actions by the Status1 to easy follow the flow of the game.  </span>
<span class="doccomment">//! ## Clippy</span>
<span class="doccomment">//! Clippy is very useful to teach us how to program in a better way.  </span>
<span class="doccomment">//! These are not syntax errors, but hints how to do it in a more Rusty way (idiomatic).  </span>
<span class="doccomment">//! Some lints are problematic and they are explicitly allowed here.</span>
<span class="doccomment">//! ## Cargo make</span>
<span class="doccomment">//! I prepared some flows and tasks for Cargo make.  </span>
<span class="doccomment">//! `cargo make` - lists the possible available/public flows/tasks  </span>
<span class="doccomment">//! `cargo make dev` - builds the development version and runs the server and the browser  </span>
<span class="doccomment">//! `cargo make release` - builds the release version and runs the server and the browser  </span>
<span class="doccomment">//! `cargo make doc` - build the `/target/doc` folder and copy to the `../docs` folder.  </span>

<span class="comment">//endregion: lmake_readme insert &quot;readme.md&quot;</span>

<span class="comment">//needed for dodrio! macro (typed-html)</span>
<span class="attribute">#![<span class="ident">recursion_limit</span> <span class="op">=</span> <span class="string">&quot;512&quot;</span>]</span>
<span class="comment">//region: Clippy</span>
<span class="attribute">#![<span class="ident">warn</span>(
    <span class="ident">clippy</span>::<span class="ident">all</span>,
    <span class="ident">clippy</span>::<span class="ident">restriction</span>,
    <span class="ident">clippy</span>::<span class="ident">pedantic</span>,
    <span class="ident">clippy</span>::<span class="ident">nursery</span>,
    <span class="ident">clippy</span>::<span class="ident">cargo</span>,
    <span class="comment">//variable shadowing is idiomatic to Rust, but unnatural to me.</span>
    <span class="ident">clippy</span>::<span class="ident">shadow_reuse</span>,
    <span class="ident">clippy</span>::<span class="ident">shadow_same</span>,
    <span class="ident">clippy</span>::<span class="ident">shadow_unrelated</span>,

)]</span>
<span class="attribute">#![<span class="ident">allow</span>(
    <span class="comment">//library from dependencies have this clippy warnings. Not my code.</span>
    <span class="comment">//Why is this bad: It will be more difficult for users to discover the purpose of the crate, </span>
    <span class="comment">//and key information related to it.</span>
    <span class="ident">clippy</span>::<span class="ident">cargo_common_metadata</span>,
    <span class="comment">//Why is this bad : This bloats the size of targets, and can lead to confusing error messages when </span>
    <span class="comment">//structs or traits are used interchangeably between different versions of a crate.</span>
    <span class="ident">clippy</span>::<span class="ident">multiple_crate_versions</span>,
    <span class="comment">//Why is this bad : As the edition guide says, it is highly unlikely that you work with any possible </span>
    <span class="comment">//version of your dependency, and wildcard dependencies would cause unnecessary </span>
    <span class="comment">//breakage in the ecosystem.</span>
    <span class="ident">clippy</span>::<span class="ident">wildcard_dependencies</span>,
    <span class="comment">//Rust is more idiomatic without return statement</span>
    <span class="comment">//Why is this bad : Actually omitting the return keyword is idiomatic Rust code. </span>
    <span class="comment">//Programmers coming from other languages might prefer the expressiveness of return. </span>
    <span class="comment">//It’s possible to miss the last returning statement because the only difference </span>
    <span class="comment">//is a missing ;. Especially in bigger code with multiple return paths having a </span>
    <span class="comment">//return keyword makes it easier to find the corresponding statements.</span>
    <span class="ident">clippy</span>::<span class="ident">implicit_return</span>,
    <span class="comment">//I have private function inside a function. Self does not work there.</span>
    <span class="comment">//Why is this bad: Unnecessary repetition. Mixed use of Self and struct name feels inconsistent.</span>
    <span class="ident">clippy</span>::<span class="ident">use_self</span>,
    <span class="comment">//Cannot add #[inline] to the start function with #[wasm_bindgen(start)]</span>
    <span class="comment">//because then wasm-pack build --target web returns an error: export run not found </span>
    <span class="comment">//Why is this bad: In general, it is not. Functions can be inlined across crates when that’s profitable </span>
    <span class="comment">//as long as any form of LTO is used. When LTO is disabled, functions that are not #[inline] </span>
    <span class="comment">//cannot be inlined across crates. Certain types of crates might intend for most of the </span>
    <span class="comment">//methods in their public API to be able to be inlined across crates even when LTO is disabled. </span>
    <span class="comment">//For these types of crates, enabling this lint might make sense. It allows the crate to </span>
    <span class="comment">//require all exported methods to be #[inline] by default, and then opt out for specific </span>
    <span class="comment">//methods where this might not make sense.</span>
    <span class="ident">clippy</span>::<span class="ident">missing_inline_in_public_items</span>,
    <span class="comment">//Why is this bad: This is only checked against overflow in debug builds. In some applications one wants explicitly checked, wrapping or saturating arithmetic.</span>
    <span class="comment">//clippy::integer_arithmetic,</span>
    <span class="comment">//Why is this bad: For some embedded systems or kernel development, it can be useful to rule out floating-point numbers.</span>
    <span class="ident">clippy</span>::<span class="ident">float_arithmetic</span>,
    <span class="comment">//Why is this bad : Doc is good. rustc has a MISSING_DOCS allowed-by-default lint for public members, but has no way to enforce documentation of private items. This lint fixes that.</span>
    <span class="ident">clippy</span>::<span class="ident">doc_markdown</span>,
    <span class="comment">//Why is this bad : Splitting the implementation of a type makes the code harder to navigate.</span>
    <span class="ident">clippy</span>::<span class="ident">multiple_inherent_impl</span>,
)]</span>
<span class="comment">//endregion</span>

<span class="comment">//region: mod is used only in lib file. All the rest use use crate</span>
<span class="kw">mod</span> <span class="ident">divcardmoniker</span>;
<span class="kw">mod</span> <span class="ident">divfordebugging</span>;
<span class="kw">mod</span> <span class="ident">divgridcontainer</span>;
<span class="kw">mod</span> <span class="ident">divplayeractions</span>;
<span class="kw">mod</span> <span class="ident">divplayersandscores</span>;
<span class="kw">mod</span> <span class="ident">divrulesanddescription</span>;
<span class="kw">mod</span> <span class="ident">fetchmod</span>;
<span class="kw">mod</span> <span class="ident">fetchgameconfig</span>;
<span class="kw">mod</span> <span class="ident">gamedata</span>;
<span class="kw">mod</span> <span class="ident">javascriptimportmod</span>;
<span class="kw">mod</span> <span class="ident">logmod</span>;
<span class="kw">mod</span> <span class="ident">rootrenderingcomponent</span>;
<span class="kw">mod</span> <span class="ident">statusinviteaskbegin</span>;
<span class="kw">mod</span> <span class="ident">statusinviteasked</span>;
<span class="kw">mod</span> <span class="ident">statusinviteasking</span>;
<span class="kw">mod</span> <span class="ident">statusplayagain</span>;
<span class="kw">mod</span> <span class="ident">statusplaybefore1stcard</span>;
<span class="kw">mod</span> <span class="ident">statusplaybefore2ndcard</span>;
<span class="kw">mod</span> <span class="ident">statustaketurnbegin</span>;
<span class="kw">mod</span> <span class="ident">websocketcommunication</span>;
<span class="kw">mod</span> <span class="ident">websocketreconnect</span>;
<span class="comment">//endregion</span>

<span class="comment">//region: extern and use statements</span>
<span class="comment">//Strum is a set of macros and traits for working with enums and strings easier in Rust.</span>
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">console_error_panic_hook</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">log</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">serde</span>;
<span class="attribute">#[<span class="ident">macro_use</span>]</span>
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">serde_derive</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">mem4_common</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">serde_json</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">strum</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">strum_macros</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">web_sys</span>;
<span class="attribute">#[<span class="ident">macro_use</span>]</span>
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">unwrap</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">conv</span>;

<span class="kw">use</span> <span class="ident">rand</span>::<span class="ident">rngs</span>::<span class="ident">SmallRng</span>;
<span class="kw">use</span> <span class="ident">rand</span>::<span class="ident">FromEntropy</span>;
<span class="kw">use</span> <span class="ident">rand</span>::<span class="ident">Rng</span>;
<span class="kw">use</span> <span class="ident">wasm_bindgen</span>::<span class="ident">prelude</span>::<span class="kw-2">*</span>;
<span class="comment">//endregion</span>

<span class="comment">//region: wasm_bindgen(start) is where everything starts</span>
<span class="attribute">#[<span class="ident">wasm_bindgen</span>(<span class="ident">start</span>)]</span>
<span class="doccomment">///To start the Wasm application, wasm_bindgen runs this functions</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">run</span>() <span class="op">-&gt;</span> <span class="prelude-ty">Result</span><span class="op">&lt;</span>(), <span class="ident">JsValue</span><span class="op">&gt;</span> {
    <span class="comment">// Initialize debugging for when/if something goes wrong.</span>
    <span class="ident">console_error_panic_hook</span>::<span class="ident">set_once</span>();

    <span class="comment">// Get the document&#39;s container to render the virtual Dom component.</span>
    <span class="kw">let</span> <span class="ident">window</span> <span class="op">=</span> <span class="macro">unwrap</span><span class="macro">!</span>(<span class="ident">web_sys</span>::<span class="ident">window</span>(), <span class="string">&quot;error: web_sys::window&quot;</span>);
    <span class="kw">let</span> <span class="ident">document</span> <span class="op">=</span> <span class="macro">unwrap</span><span class="macro">!</span>(<span class="ident">window</span>.<span class="ident">document</span>(), <span class="string">&quot;error: window.document&quot;</span>);
    <span class="kw">let</span> <span class="ident">div_for_virtual_dom</span> <span class="op">=</span> <span class="macro">unwrap</span><span class="macro">!</span>(
        <span class="ident">document</span>.<span class="ident">get_element_by_id</span>(<span class="string">&quot;div_for_virtual_dom&quot;</span>),
        <span class="string">&quot;No #div_for_virtual_dom&quot;</span>
    );

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">rng</span> <span class="op">=</span> <span class="ident">SmallRng</span>::<span class="ident">from_entropy</span>();
    <span class="comment">//my_ws_uid is random generated on the client and sent to</span>
    <span class="comment">//WebSocket server with an url param</span>
    <span class="kw">let</span> <span class="ident">my_ws_uid</span>: <span class="ident">usize</span> <span class="op">=</span> <span class="ident">rng</span>.<span class="ident">gen_range</span>(<span class="number">1</span>, <span class="number">9999</span>);

    <span class="comment">//find out URL</span>
    <span class="kw">let</span> <span class="ident">location_href</span> <span class="op">=</span> <span class="macro">unwrap</span><span class="macro">!</span>(<span class="ident">window</span>.<span class="ident">location</span>().<span class="ident">href</span>(), <span class="string">&quot;href not known&quot;</span>);

    <span class="comment">//WebSocket connection</span>
    <span class="kw">let</span> <span class="ident">ws</span> <span class="op">=</span> <span class="ident">websocketcommunication</span>::<span class="ident">setup_ws_connection</span>(<span class="ident">location_href</span>.<span class="ident">clone</span>(), <span class="ident">my_ws_uid</span>);
    <span class="comment">//I don&#39;t know why is needed to clone the WebSocket connection</span>
    <span class="kw">let</span> <span class="ident">ws_c</span> <span class="op">=</span> <span class="ident">ws</span>.<span class="ident">clone</span>();

    <span class="comment">// Construct a new RootRenderingComponent.</span>
    <span class="comment">//I added ws_c so that I can send messages on WebSocket</span>

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">root_rendering_component</span> <span class="op">=</span>
        <span class="ident">rootrenderingcomponent</span>::<span class="ident">RootRenderingComponent</span>::<span class="ident">new</span>(<span class="ident">ws_c</span>, <span class="ident">my_ws_uid</span>);
    <span class="ident">root_rendering_component</span>.<span class="ident">game_data</span>.<span class="ident">href</span> <span class="op">=</span> <span class="ident">location_href</span>;

    <span class="comment">// Mount the component to the `&lt;div id=&quot;div_for_virtual_dom&quot;&gt;`.</span>
    <span class="kw">let</span> <span class="ident">vdom</span> <span class="op">=</span> <span class="ident">dodrio</span>::<span class="ident">Vdom</span>::<span class="ident">new</span>(<span class="kw-2">&amp;</span><span class="ident">div_for_virtual_dom</span>, <span class="ident">root_rendering_component</span>);

    <span class="ident">websocketcommunication</span>::<span class="ident">setup_all_ws_events</span>(<span class="kw-2">&amp;</span><span class="ident">ws</span>, <span class="ident">vdom</span>.<span class="ident">weak</span>());

    <span class="comment">// Run the component forever. Forget to drop the memory.</span>
    <span class="ident">vdom</span>.<span class="ident">forget</span>();

    <span class="prelude-val">Ok</span>(())
}
<span class="comment">//endregion</span>

<span class="doccomment">/// Get the top-level window&#39;s session storage.</span>
<span class="doccomment">/// TODO: to save user preferences maybe?</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">session_storage</span>() <span class="op">-&gt;</span> <span class="ident">web_sys</span>::<span class="ident">Storage</span> {
    <span class="kw">let</span> <span class="ident">window</span> <span class="op">=</span> <span class="macro">unwrap</span><span class="macro">!</span>(<span class="ident">web_sys</span>::<span class="ident">window</span>(), <span class="string">&quot;error: web_sys::window&quot;</span>);
    <span class="ident">window</span>.<span class="ident">session_storage</span>().<span class="ident">unwrap_throw</span>().<span class="ident">unwrap_throw</span>()
}
<span class="comment">//endregion</span>
</pre></div>
</section><section id="search" class="content hidden"></section><section class="footer"></section><aside id="help" class="hidden"><div><h1 class="hidden">Help</h1><div class="shortcuts"><h2>Keyboard Shortcuts</h2><dl><dt><kbd>?</kbd></dt><dd>Show this help dialog</dd><dt><kbd>S</kbd></dt><dd>Focus the search field</dd><dt><kbd>↑</kbd></dt><dd>Move up in search results</dd><dt><kbd>↓</kbd></dt><dd>Move down in search results</dd><dt><kbd>↹</kbd></dt><dd>Switch tab</dd><dt><kbd>&#9166;</kbd></dt><dd>Go to active search result</dd><dt><kbd>+</kbd></dt><dd>Expand all sections</dd><dt><kbd>-</kbd></dt><dd>Collapse all sections</dd></dl></div><div class="infos"><h2>Search Tricks</h2><p>Prefix searches with a type followed by a colon (e.g., <code>fn:</code>) to restrict the search to a given type.</p><p>Accepted types are: <code>fn</code>, <code>mod</code>, <code>struct</code>, <code>enum</code>, <code>trait</code>, <code>type</code>, <code>macro</code>, and <code>const</code>.</p><p>Search functions by type signature (e.g., <code>vec -> usize</code> or <code>* -> vec</code>)</p><p>Search multiple things at once by splitting your query with comma (e.g., <code>str,u8</code> or <code>String,struct:Vec,test</code>)</p></div></div></aside><script>window.rootPath = "../../";window.currentCrate = "mem4";</script><script src="../../aliases.js"></script><script src="../../main.js"></script><script src="../../source-script.js"></script><script src="../../source-files.js"></script><script defer src="../../search-index.js"></script></body></html>